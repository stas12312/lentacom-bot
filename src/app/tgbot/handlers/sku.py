from aiogram import Dispatcher
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters import Text
from aiogram.types import Message

from lenta.client import LentaClient
from tgbot import services
from tgbot.keyboards import buttons
from tgbot.keyboards.menu import MAIN_MENU, CANCEL_MENU
from tgbot.keyboards.sku import get_sku_keyboard
from tgbot.models.states import SearchSku
from tgbot.services.repository import Repo


async def start_search_sku(msg: Message):
    """ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ° Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°"""
    await SearchSku.select_sku.set()
    await msg.answer("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ°", reply_markup=CANCEL_MENU)


async def show_founded_skus(msg: Message, repo: Repo, lenta: LentaClient, state: FSMContext):
    """ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¾Ğ²"""
    sku_name = msg.text
    user_store_id = await services.profile.get_user_store_id(repo, msg.from_user.id)
    skus = await services.sku.search_sku_in_store(user_store_id, sku_name, lenta)
    skus_info_message = services.messages.get_sku_list_message("ğŸ—’ ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹", skus, True)
    await msg.answer(skus_info_message, reply_markup=MAIN_MENU)
    await state.finish()


async def show_sku_detail(msg: Message, repo: Repo, lenta: LentaClient):
    """ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ´ĞºÑƒÑ‚Ğ°"""
    sku_code = msg.text.split("_")[1]
    sku = await services.profile.get_user_sku(msg.from_user.id, sku_code, repo, lenta)
    sku_info_message = services.messages.get_sku_info_message(sku)
    sku_keyboard = await get_sku_keyboard(msg.from_user.id, sku_code, repo)
    await msg.answer(sku_info_message, reply_markup=sku_keyboard)


def register_sku(dp: Dispatcher) -> None:
    dp.register_message_handler(start_search_sku, text=buttons.SEARCH_SKU)
    dp.register_message_handler(show_founded_skus, state=SearchSku.select_sku)
    dp.register_message_handler(show_sku_detail, Text(startswith="/detail_"))
